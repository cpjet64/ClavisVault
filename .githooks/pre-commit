#!/usr/bin/env sh
set -eu

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$repo_root" ]; then
  echo "pre-commit: unable to determine repository root" >&2
  exit 1
fi
cd "$repo_root"

if command -v just >/dev/null 2>&1; then
  just ci-fast
fi

if command -v cargo >/dev/null 2>&1 && command -v cargo-llvm-cov >/dev/null 2>&1; then
  cargo llvm-cov test --package clavisvault-core --lib --fail-under-lines 76
else
  echo "pre-commit: cargo-llvm-cov not installed — skipping coverage gate" >&2
fi

if ! command -v just >/dev/null 2>&1; then
  echo "pre-commit: 'just' not found — skipping ci-fast" >&2
fi

exit 0
